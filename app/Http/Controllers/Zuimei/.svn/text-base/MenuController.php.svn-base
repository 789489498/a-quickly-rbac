<?php

namespace Qihoo;

class MenuController extends \BaseController
{
    public $defaultPage = 1;
    public $defaultPageSize = 20;

    public function getListAction()
    {
        $page = $this->defaultPage;
        $pageSize = $this->defaultPageSize;
        $params = array();
        list($total, $records) = Menu::getQuery($page, $pageSize, $params);
        $totalPages = ceil($total / $pageSize);
        $menuMap = Menu::getMenuMap();
        $levelMap = Menu::getLevelMap();

        return \View::make("qihoo.menu.list", array(
            'records' => $records,
            'total' => $total,
            'page'  => $page,
            'totalPages' => $totalPages,
            'pageSize' => $pageSize,
            'menuMap' => $menuMap,
            'levelMap' => $levelMap,
        ));
    }

    public function postQueryAction()
    {
        $page = \Input::get('page') ? : $this->defaultPage;
        $pageSize = \Input::get('page_size') ? : $this->defaultPageSize;
        $params = $this->getQueryParams();
        list($total, $records) = Menu::getQuery($page, $pageSize, $params);
        $totalPages = ceil($total / $pageSize);
        $menuMap = Menu::getMenuMap();
        $levelMap = Menu::getLevelMap();

        return \View::make("qihoo.menu.query", array(
            'records' => $records,
            'total' => $total,
            'page'  => $page,
            'totalPages' => $totalPages,
            'pageSize' => $pageSize,
            'menuMap' => $menuMap,
            'levelMap' => $levelMap,
        ));
    }

    public function getAddAction()
    {
        $result = \DB::select("select * from " . Menu::TABLE . " where level<3 order by level");;
        $pids = array();
        if (!empty($result)) {
            foreach ($result as $v) {
                //$pids[$v->id] = $v->name . " 【" . ($v->level == 1 ? "一" : "二") . "级菜单】";
                $pids[$v->id] = array(
                    "name" => $v->name,
                    "level" => $v->level,
                );
            }
        }

        return \View::make("qihoo.menu.add", array('pids' => $pids));
    }

    public function postAddAction()
    {
        $data = array(
            'name' => \Input::get('name'),
            'pid'  => \Input::get('pid'),
            'type' => \Input::get('type'),
        );

        if ($data['pid'] == 0) {
            $level = 1;
        } else {
            $pMenu = \DB::findOne(Menu::TABLE, array('id' => $data['pid']));
            if (empty($pMenu)) {
                throw new \Exception("pMenu not found");
            }
            $level = $pMenu->level + 1;

            // 只有父菜单是节点菜单才可建立
            if ($pMenu->type == 1) {
                throw new \Exception("pMenu is a terminal menu, does not allow submenu");
            }
        }

        $menu = array(
            'name'  => $data['name'],
            'pid'   => $data['pid'],
            'level' => $level,
            // 一级菜单肯定是节点菜单，三级菜单肯定是末端菜单
            'type'  => $level == 1 ? 0 : ($level == 3 ? 1 : $data['type']),
            'create_time' => date('Y-m-d'),
            'operator'    => User::getUsername(),
        );
        \DB::insert(Menu::TABLE, $menu);

        return \Response::redirect(\URL::route("Qihoo\MenuController@getAddAction"));
    }

    public function getUpdateAction()
    {
        $id = \Input::get("id");
        if (empty($id)) {
            throw new \Exception("id is missing");
        }
        $menu = \DB::findOne(Menu::TABLE, array('id' => $id));
        if (empty($menu)) {
            throw new \Exception("menu not found");
        }

        return \View::make("qihoo.menu.update", array("menu" => $menu));
    }

    public function postUpdateAction()
    {
        $data = array(
            'id'   => \Input::get('id'),
            'name' => \Input::get('name'),
        );
        if (empty($data['id']) || empty($data['name'])) {
            throw new \Exception("id or name is missing");
        }

        $menu = \DB::findOne(Menu::TABLE, array('id' => $data['id']));
        if (empty($menu)) {
            throw new \Exception("menu not found");
        }

        $newerMenu = array(
            'name'     => $data['name'],
            'operator' => User::getUsername(),
        );
        \DB::update(Menu::TABLE, $newerMenu, array('id' => $data['id']));

        return \Response::redirect(\URL::route("Qihoo\MenuController@getUpdateAction", array("id" => $data['id'])));
    }

    public function getDeleteAction()
    {
        $data = array(
            'id' => \Input::get("id"),
        );

        if (empty($data['id'])) {
            throw new \Exception("id is missing");
        }
        $menu = \DB::findOne(Menu::TABLE, array("id" => $data["id"]));
        if (empty($menu)) {
            throw new \Exception("menu not found");
        }
        \DB::delete(Menu::TABLE, array('id' => $menu->id));
        \DB::delete(Route::TABLE, array('mid_1' => $menu->id));
        \DB::delete(Route::TABLE, array('mid_2' => $menu->id));
        \DB::delete(Route::TABLE, array('mid_3' => $menu->id));

        return \Response::redirect(\URL::route("Qihoo\MenuController@getListAction"));
    }

    protected function getQueryParams()
    {
        $params = array();
        $level = \Input::get('level');

        if (!empty($level)) {
            $params['level'] = $level;
        }

        return $params;
    }
}
