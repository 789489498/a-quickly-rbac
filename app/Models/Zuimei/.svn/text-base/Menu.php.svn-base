<?php

namespace Qihoo;

class Menu
{
    const TABLE = "qihoo_menu";

    public static function getQuery($page, $pageSize, $params)
    {
        $table = "qihoo_menu as m";
        $where = self::getQueryConditions($params);
        $offset = ($page - 1) * $pageSize;
        $limit = "limit {$pageSize} offset {$offset}";

        $totalSql = "select count(*) as total from $table $where";
        $result = \DB::select($totalSql, $params);
        $total = empty($result) ? 0 : $result[0]->total;

        $sql = "select * from $table $where $limit";
        $result = \DB::select($sql, $params);

        return array($total, $result);
    }

    public static function getQueryConditions(&$params)
    {
        $conditions = array();
        if (!empty($params['level'])) {
            $conditions[] = "m.level=:level";
        }

        $where = implode(" and ", $conditions);
        if (empty($where)) {
            return "";
        } else {
            return "where {$where}";
        }
    }

    public static function getMenuMap()
    {
        $result = \DB::all(self::TABLE);
        $menus = array(0 => '无');
        foreach ($result as $v) {
            $menus[$v->id] = $v->name;
        }
        return $menus;
    }

    public static function getLevelMap()
    {
        return array(
            '1' => '一级菜单',
            '2' => '二级菜单',
            '3' => '三级菜单',
        );
    }

    /**
     * 获取用户拥有权限的菜单列表供左侧菜单栏展示
     */
    public static function getAuthMenus()
    {
        $userRoutes = UserRole::userRoutes(User::getUsername());

        $allMenu = \DB::all(self::TABLE);
        $menus = array();
        foreach ($allMenu as $v) {
            // 只允许三级或二级菜单可以有默认路由
            if ($v->level == 3 || $v->level == 2) {
                //获取三级或二级菜单的默认路由
                $defaultRoute = Route::getDefaultRoute($v->id, $v->level);
                if (empty($defaultRoute)) {
                    continue;
                }
                if (!in_array($defaultRoute, $userRoutes)) {
                    continue;
                }

                if ($v->level == 3) {
                    $level2[$v->pid][$v->id] = \URL::route($defaultRoute);
                } elseif ($v->level == 2) {
                    $level2[$v->id] = \URL::route($defaultRoute);
                }
            }
        }

        if (empty($level2)) {
            return $menus;
        }

        foreach ($allMenu as $v) {
            if (($v->level == 2) && array_key_exists($v->id, $level2)) {
                // if $level2[$v->id] is array, then it is a parent menu, otherwise it is a route
                $menus[$v->pid][$v->id] = $level2[$v->id];
            }
        }

        return $menus;
    }

    /**
     * 获取当前路由所在菜单
     */
    public static function getCurrentMenu()
    {
        $currentRoute = \Route::currentRouteAction();
        $route = \DB::findOne(Route::TABLE, array('route' => $currentRoute));
        if (empty($route)) {
            return array(); // 允许存在不需要归属到某个菜单（主）的静态页，leftmenu会根据currentMenu显示active，首页没有菜单，因此leftmenu需要先判断是否有菜单再判断是否active
        } else {
            //pageheader 会根据末级菜单名显示默认TITLE，因此没有的级别就不要设置，以免只有二级菜单结果去取三级菜单的名称
            if (!empty($route->mid_1)) {
                $currentMenu[1] = $route->mid_1;
            }
            if (!empty($route->mid_2)) {
                $currentMenu[2] = $route->mid_2;
            }
            if (!empty($route->mid_3)) {
                $currentMenu[3] = $route->mid_3;
            }
        }

        return $currentMenu;
    }
}
